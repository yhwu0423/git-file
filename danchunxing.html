<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>单纯形法演示工具</title>
    <style>
        /* 
         * CSS 样式部分
         * 定义网页的整体外观和布局
         2025/10/23
         */
        
        /* 重置所有元素的默认样式 */
        * {
            box-sizing: border-box;  /* 盒模型设置为border-box，便于布局计算 */
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;  /* 设置字体 */
        }
        
        /* 页面主体样式 */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);  /* 渐变背景 */
            color: #333;  /* 文字颜色 */
            line-height: 1.6;  /* 行高 */
            padding: 20px;  /* 内边距 */
            min-height: 100vh;  /* 最小高度为视口高度 */
        }
        
        /* 主容器样式 */
        .container {
            max-width: 1200px;  /* 最大宽度 */
            margin: 0 auto;  /* 水平居中 */
            background: white;  /* 白色背景 */
            border-radius: 15px;  /* 圆角边框 */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);  /* 阴影效果 */
            overflow: hidden;  /* 隐藏溢出内容 */
        }
        
        /* 头部样式 */
        header {
            background: linear-gradient(135deg, #2c3e50, #4a6491);  /* 渐变背景 */
            color: white;  /* 白色文字 */
            padding: 25px;  /* 内边距 */
            text-align: center;  /* 文字居中 */
        }
        
        /* 主标题样式 */
        h1 {
            font-size: 2.5rem;  /* 字体大小 */
            margin-bottom: 10px;  /* 底部外边距 */
        }
        
        /* 副标题样式 */
        .subtitle {
            font-size: 1.2rem;  /* 字体大小 */
            opacity: 0.9;  /* 透明度 */
        }
        
        /* 内容区域样式 */
        .content {
            display: flex;  /* 弹性布局 */
            flex-wrap: wrap;  /* 允许换行 */
            padding: 0;  /* 无内边距 */
        }
        
        /* 输入区域样式 */
        .input-section {
            flex: 1;  /* 弹性比例1 */
            min-width: 300px;  /* 最小宽度 */
            padding: 25px;  /* 内边距 */
            background: #f8f9fa;  /* 浅灰色背景 */
            border-right: 1px solid #e9ecef;  /* 右边框 */
        }
        
        /* 输出区域样式 */
        .output-section {
            flex: 2;  /* 弹性比例2 */
            min-width: 500px;  /* 最小宽度 */
            padding: 25px;  /* 内边距 */
            background: white;  /* 白色背景 */
        }
        
        /* 区域标题样式 */
        .section-title {
            font-size: 1.5rem;  /* 字体大小 */
            margin-bottom: 20px;  /* 底部外边距 */
            color: #2c3e50;  /* 文字颜色 */
            border-bottom: 2px solid #4a6491;  /* 底部边框 */
            padding-bottom: 10px;  /* 底部内边距 */
        }
        
        /* 表单组样式 */
        .form-group {
            margin-bottom: 20px;  /* 底部外边距 */
        }
        
        /* 标签样式 */
        label {
            display: block;  /* 块级显示 */
            margin-bottom: 8px;  /* 底部外边距 */
            font-weight: 600;  /* 字体粗细 */
            color: #495057;  /* 文字颜色 */
        }
        
        /* 输入框和选择框样式 */
        input, select {
            width: 100%;  /* 宽度100% */
            padding: 12px;  /* 内边距 */
            border: 1px solid #ced4da;  /* 边框 */
            border-radius: 6px;  /* 圆角 */
            font-size: 16px;  /* 字体大小 */
            transition: border-color 0.3s;  /* 边框颜色过渡效果 */
        }
        
        /* 输入框和选择框获得焦点时的样式 */
        input:focus, select:focus {
            border-color: #4a6491;  /* 边框颜色 */
            outline: none;  /* 移除默认轮廓 */
            box-shadow: 0 0 0 3px rgba(74, 100, 145, 0.2);  /* 阴影效果 */
        }
        
        /* 约束条件样式 */
        .constraint {
            background: white;  /* 白色背景 */
            border-radius: 8px;  /* 圆角 */
            padding: 15px;  /* 内边距 */
            margin-bottom: 15px;  /* 底部外边距 */
            border: 1px solid #e9ecef;  /* 边框 */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);  /* 阴影效果 */
        }
        
        /* 约束条件头部样式 */
        .constraint-header {
            display: flex;  /* 弹性布局 */
            justify-content: space-between;  /* 两端对齐 */
            align-items: center;  /* 垂直居中 */
            margin-bottom: 10px;  /* 底部外边距 */
        }
        
        /* 约束条件标题样式 */
        .constraint-title {
            font-weight: 600;  /* 字体粗细 */
            color: #495057;  /* 文字颜色 */
        }
        
        /* 删除约束按钮样式 */
        .remove-constraint {
            background: #e74c3c;  /* 红色背景 */
            color: white;  /* 白色文字 */
            border: none;  /* 无边框 */
            border-radius: 4px;  /* 圆角 */
            padding: 5px 10px;  /* 内边距 */
            cursor: pointer;  /* 手型光标 */
            font-size: 14px;  /* 字体大小 */
        }
        
        /* 系数输入区域样式 */
        .coefficient-inputs {
            display: flex;  /* 弹性布局 */
            flex-wrap: wrap;  /* 允许换行 */
            gap: 10px;  /* 元素间距 */
            margin-bottom: 10px;  /* 底部外边距 */
        }
        
        /* 系数输入框样式 */
        .coeff-input {
            flex: 1;  /* 弹性比例1 */
            min-width: 80px;  /* 最小宽度 */
        }
        
        /* 约束条件控制区域样式 */
        .constraint-controls {
            display: flex;  /* 弹性布局 */
            gap: 10px;  /* 元素间距 */
        }
        
        /* 约束类型和右侧值输入框样式 */
        .constraint-type, .constraint-rhs {
            flex: 1;  /* 弹性比例1 */
        }
        
        /* 按钮基础样式 */
        button {
            background: #4a6491;  /* 背景颜色 */
            color: white;  /* 文字颜色 */
            border: none;  /* 无边框 */
            border-radius: 6px;  /* 圆角 */
            padding: 12px 20px;  /* 内边距 */
            font-size: 16px;  /* 字体大小 */
            cursor: pointer;  /* 手型光标 */
            transition: background 0.3s;  /* 背景颜色过渡效果 */
            font-weight: 600;  /* 字体粗细 */
        }
        
        /* 按钮悬停效果 */
        button:hover {
            background: #3a5379;  /* 深色背景 */
        }
        
        /* 主要按钮样式 */
        .btn-primary {
            background: #28a745;  /* 绿色背景 */
        }
        
        /* 主要按钮悬停效果 */
        .btn-primary:hover {
            background: #218838;  /* 深绿色背景 */
        }
        
        /* 危险按钮样式 */
        .btn-danger {
            background: #e74c3c;  /* 红色背景 */
        }
        
        /* 危险按钮悬停效果 */
        .btn-danger:hover {
            background: #c0392b;  /* 深红色背景 */
        }
        
        /* 按钮组样式 */
        .button-group {
            display: flex;  /* 弹性布局 */
            gap: 10px;  /* 元素间距 */
            margin-top: 20px;  /* 顶部外边距 */
        }
        
        /* 步骤导航样式 */
        .step-navigation {
            display: flex;  /* 弹性布局 */
            justify-content: space-between;  /* 两端对齐 */
            margin-bottom: 20px;  /* 底部外边距 */
            background: #f8f9fa;  /* 浅灰色背景 */
            padding: 15px;  /* 内边距 */
            border-radius: 8px;  /* 圆角 */
        }
        
        /* 步骤信息样式 */
        .step-info {
            font-weight: 600;  /* 字体粗细 */
            color: #495057;  /* 文字颜色 */
        }
        
        /* 单纯形表容器样式 */
        .tableau-container {
            overflow-x: auto;  /* 水平滚动 */
            margin-bottom: 20px;  /* 底部外边距 */
            border: 1px solid #e9ecef;  /* 边框 */
            border-radius: 8px;  /* 圆角 */
        }
        
        /* 表格样式 */
        table {
            width: 100%;  /* 宽度100% */
            border-collapse: collapse;  /* 边框合并 */
        }
        
        /* 表头和单元格样式 */
        th, td {
            padding: 12px 15px;  /* 内边距 */
            text-align: center;  /* 文字居中 */
            border: 1px solid #e9ecef;  /* 边框 */
        }
        
        /* 表头样式 */
        th {
            background: #4a6491;  /* 背景颜色 */
            color: white;  /* 文字颜色 */
            font-weight: 600;  /* 字体粗细 */
        }
        
        /* 表格偶数行背景色 */
        tr:nth-child(even) {
            background: #f8f9fa;  /* 浅灰色背景 */
        }
        
        /* 基变量单元格样式 */
        .basis-cell {
            background: #e8f4fd;  /* 浅蓝色背景 */
            font-weight: 600;  /* 字体粗细 */
        }
        
        /* 枢轴元素单元格样式 */
        .pivot-cell {
            background: #ffeb3b;  /* 黄色背景 */
            font-weight: 600;  /* 字体粗细 */
        }
        
        /* 进基变量列样式 */
        .entering-cell {
            background: #c8e6c9;  /* 浅绿色背景 */
        }
        
        /* 解决方案信息区域样式 */
        .solution-info {
            background: #e8f4fd;  /* 浅蓝色背景 */
            padding: 15px;  /* 内边距 */
            border-radius: 8px;  /* 圆角 */
            margin-top: 20px;  /* 顶部外边距 */
        }
        
        /* 解决方案值样式 */
        .solution-value {
            font-size: 1.2rem;  /* 字体大小 */
            font-weight: 600;  /* 字体粗细 */
            color: #2c3e50;  /* 文字颜色 */
            margin-bottom: 10px;  /* 底部外边距 */
        }
        
        /* 变量值容器样式 */
        .variables-values {
            display: flex;  /* 弹性布局 */
            flex-wrap: wrap;  /* 允许换行 */
            gap: 15px;  /* 元素间距 */
        }
        
        /* 单个变量值样式 */
        .variable-value {
            background: white;  /* 白色背景 */
            padding: 10px 15px;  /* 内边距 */
            border-radius: 6px;  /* 圆角 */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);  /* 阴影效果 */
        }
        
        /* 使用说明区域样式 */
        .instructions {
            background: #fff3cd;  /* 浅黄色背景 */
            border: 1px solid #ffeaa7;  /* 边框 */
            border-radius: 8px;  /* 圆角 */
            padding: 15px;  /* 内边距 */
            margin-bottom: 20px;  /* 底部外边距 */
        }
        
        /* 使用说明标题样式 */
        .instructions h3 {
            color: #856404;  /* 文字颜色 */
            margin-bottom: 10px;  /* 底部外边距 */
        }
        
        /* 使用说明列表样式 */
        .instructions ul {
            padding-left: 20px;  /* 左内边距 */
        }
        
        /* 使用说明列表项样式 */
        .instructions li {
            margin-bottom: 8px;  /* 底部外边距 */
        }
        
        /* 错误消息样式 */
        .error-message {
            background: #f8d7da;  /* 浅红色背景 */
            color: #721c24;  /* 文字颜色 */
            padding: 10px;  /* 内边距 */
            border-radius: 4px;  /* 圆角 */
            margin: 10px 0;  /* 上下外边距 */
        }
        
        /* 响应式设计 - 小屏幕适配 */
        @media (max-width: 768px) {
            .content {
                flex-direction: column;  /* 垂直布局 */
            }
            
            .input-section {
                border-right: none;  /* 移除右边框 */
                border-bottom: 1px solid #e9ecef;  /* 添加底部边框 */
            }
        }
    </style>
</head>
<body>
    <!-- 主容器 -->
    <div class="container">
        <!-- 页面头部 -->
        <header>
            <h1>单纯形法演示工具</h1>
            <p class="subtitle">输入线性规划问题，查看单纯形表的每一步计算过程</p>
        </header>
        
        <!-- 内容区域 -->
        <div class="content">
            <!-- 输入区域 -->
            <div class="input-section">
                <h2 class="section-title">问题输入</h2>
                
                <!-- 使用说明 -->
                <div class="instructions">
                    <h3>使用说明</h3>
                    <ul>
                        <li>选择目标函数类型（最大化或最小化）</li>
                        <li>输入目标函数系数</li>
                        <li>添加约束条件</li>
                        <li>点击"求解"按钮查看计算过程</li>
                    </ul>
                </div>
                
                <!-- 目标函数类型选择 -->
                <div class="form-group">
                    <label for="problemType">目标函数类型</label>
                    <select id="problemType">
                        <option value="max">最大化 (Max)</option>
                        <option value="min">最小化 (Min)</option>
                    </select>
                </div>
                
                <!-- 变量数量设置 -->
                <div class="form-group">
                    <label for="numVariables">变量数量</label>
                    <input type="number" id="numVariables" min="2" max="10" value="2">
                </div>
                
                <!-- 目标函数系数输入 -->
                <div class="form-group">
                    <label>目标函数系数</label>
                    <div id="objectiveCoefficients" class="coefficient-inputs">
                        <!-- 动态生成目标函数系数输入 -->
                    </div>
                </div>
                
                <!-- 约束条件输入 -->
                <div class="form-group">
                    <label>约束条件</label>
                    <div id="constraintsContainer">
                        <!-- 动态生成约束条件 -->
                    </div>
                    <button type="button" id="addConstraint" class="btn-primary">添加约束</button>
                </div>
                
                <!-- 操作按钮 -->
                <div class="button-group">
                    <button type="button" id="solveBtn">求解</button>
                    <button type="button" id="resetBtn" class="btn-danger">重置</button>
                </div>
            </div>
            
            <!-- 输出区域 -->
            <div class="output-section">
                <h2 class="section-title">计算过程</h2>
                
                <div id="outputContainer">
                    <!-- 初始状态提示 -->
                    <div id="initialState" class="instructions">
                        <p>请在左侧输入线性规划问题，然后点击"求解"按钮查看单纯形法的计算过程。</p>
                    </div>
                    
                    <!-- 求解步骤显示区域 -->
                    <div id="solutionSteps" style="display: none;">
                        <!-- 步骤导航 -->
                        <div class="step-navigation">
                            <button type="button" id="prevStep">上一步</button>
                            <div class="step-info">步骤 <span id="currentStep">1</span> / <span id="totalSteps">1</span></div>
                            <button type="button" id="nextStep">下一步</button>
                        </div>
                        
                        <!-- 单纯形表容器 -->
                        <div class="tableau-container">
                            <table id="tableauTable">
                                <!-- 单纯形表将通过JavaScript动态生成 -->
                            </table>
                        </div>
                        
                        <!-- 步骤解释 -->
                        <div id="stepExplanation" class="solution-info">
                            <!-- 步骤解释将通过JavaScript动态生成 -->
                        </div>
                        
                        <!-- 最终解显示 -->
                        <div id="finalSolution" class="solution-info" style="display: none;">
                            <!-- 最终解将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =============================================================================
        // 单纯形法演示工具 - JavaScript 实现
        // =============================================================================
        
        // 全局变量定义
        let currentStep = 0;      // 当前显示的步骤索引
        let steps = [];           // 存储所有计算步骤
        let numVariables = 2;     // 变量数量，默认为2
        
        // =============================================================================
        // 页面初始化函数
        // =============================================================================
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化目标函数系数输入
            updateObjectiveCoefficients();
            // 添加第一个约束条件
            addConstraint();
            
            // 事件监听器设置
            document.getElementById('numVariables').addEventListener('change', function() {
                numVariables = parseInt(this.value);
                updateObjectiveCoefficients();  // 更新目标函数系数输入
                updateConstraints();            // 更新约束条件
            });
            
            document.getElementById('addConstraint').addEventListener('click', addConstraint);
            document.getElementById('solveBtn').addEventListener('click', solveProblem);
            document.getElementById('resetBtn').addEventListener('click', resetProblem);
            document.getElementById('prevStep').addEventListener('click', prevStep);
            document.getElementById('nextStep').addEventListener('click', nextStep);
        });
        
        // =============================================================================
        // 更新目标函数系数输入函数
        // =============================================================================
        function updateObjectiveCoefficients() {
            const container = document.getElementById('objectiveCoefficients');
            container.innerHTML = '';  // 清空容器
            
            // 为每个变量创建系数输入框
            for (let i = 0; i < numVariables; i++) {
                const input = document.createElement('input');
                input.type = 'number';
                input.step = 'any';        // 允许输入小数
                input.value = i === 0 ? '3' : '2';  // 设置默认值
                input.placeholder = `x${i+1}`;      // 设置占位符
                input.className = 'coeff-input';
                container.appendChild(input);
            }
        }
        
        // =============================================================================
        // 更新约束条件函数
        // =============================================================================
        function updateConstraints() {
            const constraints = document.querySelectorAll('.constraint');
            
            // 更新每个约束条件的系数输入
            constraints.forEach(constraint => {
                const coeffInputs = constraint.querySelector('.coefficient-inputs');
                coeffInputs.innerHTML = '';
                
                for (let i = 0; i < numVariables; i++) {
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.step = 'any';
                    input.value = i === 0 ? '1' : '2';  // 设置默认值
                    input.placeholder = `x${i+1}`;
                    input.className = 'coeff-input';
                    coeffInputs.appendChild(input);
                }
            });
        }
        
        // =============================================================================
        // 添加约束条件函数
        // =============================================================================
        function addConstraint() {
            const container = document.getElementById('constraintsContainer');
            const constraintIndex = container.children.length;
            
            // 创建约束条件HTML结构
            const constraintDiv = document.createElement('div');
            constraintDiv.className = 'constraint';
            
            constraintDiv.innerHTML = `
                <div class="constraint-header">
                    <div class="constraint-title">约束 ${constraintIndex + 1}</div>
                    <button type="button" class="remove-constraint">删除</button>
                </div>
                <div class="coefficient-inputs">
                    ${Array.from({length: numVariables}, (_, i) => 
                        `<input type="number" step="any" value="${i === 0 ? '1' : '2'}" placeholder="x${i+1}" class="coeff-input">`
                    ).join('')}
                </div>
                <div class="constraint-controls">
                    <select class="constraint-type">
                        <option value="<=">≤</option>
                        <option value="=">=</option>
                        <option value=">=">≥</option>
                    </select>
                    <input type="number" step="any" class="constraint-rhs" value="10" placeholder="右侧值">
                </div>
            `;
            
            container.appendChild(constraintDiv);
            
            // 添加删除按钮事件监听
            constraintDiv.querySelector('.remove-constraint').addEventListener('click', function() {
                if (container.children.length > 1) {
                    constraintDiv.remove();
                    // 更新剩余约束条件的标题
                    const constraints = container.querySelectorAll('.constraint');
                    constraints.forEach((constraint, index) => {
                        constraint.querySelector('.constraint-title').textContent = `约束 ${index + 1}`;
                    });
                } else {
                    alert('至少需要保留一个约束条件');
                }
            });
        }
        
        // =============================================================================
        // 求解问题函数 - 主求解流程
        // =============================================================================
        function solveProblem() {
            // 收集输入数据
            const problemType = document.getElementById('problemType').value;
            const objectiveCoeffs = Array.from(document.querySelectorAll('#objectiveCoefficients input')).map(input => parseFloat(input.value));
            
            const constraints = [];
            const constraintElements = document.querySelectorAll('.constraint');
            
            // 收集所有约束条件
            constraintElements.forEach(constraint => {
                const coeffs = Array.from(constraint.querySelectorAll('.coefficient-inputs input')).map(input => parseFloat(input.value));
                const type = constraint.querySelector('.constraint-type').value;
                const rhs = parseFloat(constraint.querySelector('.constraint-rhs').value);
                
                constraints.push({
                    coefficients: coeffs,
                    type: type,
                    rhs: rhs
                });
            });
            
            // 输入验证
            if (objectiveCoeffs.some(isNaN)) {
                alert('请输入有效的目标函数系数');
                return;
            }
            
            for (let i = 0; i < constraints.length; i++) {
                if (constraints[i].coefficients.some(isNaN) || isNaN(constraints[i].rhs)) {
                    alert(`约束 ${i+1} 包含无效值`);
                    return;
                }
            }
            
            // 调用单纯形法求解
            try {
                steps = simplexSolve(problemType, objectiveCoeffs, constraints);
                
                if (steps.length === 0) {
                    alert('无法求解该问题，请检查输入');
                    return;
                }
                
                // 显示求解步骤
                document.getElementById('initialState').style.display = 'none';
                document.getElementById('solutionSteps').style.display = 'block';
                
                currentStep = 0;
                displayStep(currentStep);
            } catch (error) {
                alert('求解过程中出错: ' + error.message);
                console.error(error);
            }
        }
        
        // =============================================================================
        // 重置问题函数
        // =============================================================================
        function resetProblem() {
            document.getElementById('numVariables').value = 2;
            numVariables = 2;
            updateObjectiveCoefficients();
            
            const constraintsContainer = document.getElementById('constraintsContainer');
            constraintsContainer.innerHTML = '';
            addConstraint();
            
            document.getElementById('initialState').style.display = 'block';
            document.getElementById('solutionSteps').style.display = 'none';
        }
        
        // =============================================================================
        // 显示上一步函数
        // =============================================================================
        function prevStep() {
            if (currentStep > 0) {
                currentStep--;
                displayStep(currentStep);
            }
        }
        
        // =============================================================================
        // 显示下一步函数
        // =============================================================================
        function nextStep() {
            if (currentStep < steps.length - 1) {
                currentStep++;
                displayStep(currentStep);
            }
        }
        
        // =============================================================================
        // 显示当前步骤函数
        // =============================================================================
        function displayStep(stepIndex) {
            const step = steps[stepIndex];
            
            // 更新步骤信息显示
            document.getElementById('currentStep').textContent = stepIndex + 1;
            document.getElementById('totalSteps').textContent = steps.length;
            
            // 显示单纯形表
            displayTableau(step.tableau, step.pivotRow, step.pivotCol);
            
            // 更新步骤解释
            const explanationDiv = document.getElementById('stepExplanation');
            let explanationHTML = `<div class="solution-value">${step.description}</div>`;
            
            if (step.enteringVar) {
                explanationHTML += `<p>进基变量: ${step.enteringVar}</p>`;
            }
            if (step.leavingVar) {
                explanationHTML += `<p>离基变量: ${step.leavingVar}</p>`;
            }
            if (step.pivotValue !== undefined && step.pivotValue !== null) {
                explanationHTML += `<p>枢轴元素: ${step.pivotValue.toFixed(2)}</p>`;
            }
            
            explanationDiv.innerHTML = explanationHTML;
            
            // 如果是最后一步，显示最终解
            if (stepIndex === steps.length - 1 && step.solution) {
                displayFinalSolution(step.solution);
            } else {
                document.getElementById('finalSolution').style.display = 'none';
            }
            
            // 更新导航按钮状态
            document.getElementById('prevStep').disabled = stepIndex === 0;
            document.getElementById('nextStep').disabled = stepIndex === steps.length - 1;
        }
        
        // =============================================================================
        // 显示单纯形表函数
        // =============================================================================
        function displayTableau(tableau, pivotRow, pivotCol) {
            const table = document.getElementById('tableauTable');
            table.innerHTML = '';
            
            // 检查表格数据有效性
            if (!tableau || !tableau.variables) {
                table.innerHTML = '<tr><td colspan="10">表格数据无效</td></tr>';
                return;
            }
            
            // 创建表头
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th>基变量</th><th>CB</th>';
            
            // 添加变量名到表头
            for (let j = 0; j < tableau.variables.length; j++) {
                headerRow.innerHTML += `<th>${tableau.variables[j]}</th>`;
            }
            
            headerRow.innerHTML += '<th>解</th><th>比值</th>';
            table.appendChild(headerRow);
            
            // 创建数据行
            for (let i = 0; i < tableau.basicVars.length; i++) {
                const row = document.createElement('tr');
                
                // 基变量列
                row.innerHTML = `<td class="basis-cell">${tableau.basicVars[i]}</td>`;
                
                // CB值列
                const cbValue = tableau.cb && tableau.cb[i] !== undefined ? tableau.cb[i] : 0;
                row.innerHTML += `<td>${cbValue.toFixed(2)}</td>`;
                
                // 系数列
                for (let j = 0; j < tableau.coefficients[i].length; j++) {
                    let cellClass = '';
                    // 标记枢轴元素
                    if (i === pivotRow && j === pivotCol) {
                        cellClass = 'pivot-cell';
                    } else if (j === pivotCol) {
                        cellClass = 'entering-cell';  // 标记进基变量列
                    }
                    
                    const coeffValue = tableau.coefficients[i][j] !== undefined ? tableau.coefficients[i][j] : 0;
                    row.innerHTML += `<td class="${cellClass}">${coeffValue.toFixed(2)}</td>`;
                }
                
                // 解列
                const solutionValue = tableau.solution && tableau.solution[i] !== undefined ? tableau.solution[i] : 0;
                row.innerHTML += `<td>${solutionValue.toFixed(2)}</td>`;
                
                // 比值列
                const ratioValue = tableau.ratios && tableau.ratios[i] !== undefined ? tableau.ratios[i] : null;
                row.innerHTML += `<td>${ratioValue !== null ? ratioValue.toFixed(2) : '-'}</td>`;
                
                table.appendChild(row);
            }
            
            // 创建检验数行
            const reducedCostRow = document.createElement('tr');
            reducedCostRow.innerHTML = '<td colspan="2">检验数</td>';
            
            // 添加检验数值
            if (tableau.reducedCosts) {
                for (let j = 0; j < tableau.reducedCosts.length; j++) {
                    const rcValue = tableau.reducedCosts[j] !== undefined ? tableau.reducedCosts[j] : 0;
                    reducedCostRow.innerHTML += `<td>${rcValue.toFixed(2)}</td>`;
                }
            }
            
            // 添加目标函数值
            const zValue = tableau.zValue !== undefined ? tableau.zValue : 0;
            reducedCostRow.innerHTML += `<td>${zValue.toFixed(2)}</td><td>-</td>`;
            table.appendChild(reducedCostRow);
        }
        
        // =============================================================================
        // 显示最终解函数
        // =============================================================================
        function displayFinalSolution(solution) {
            const finalSolutionDiv = document.getElementById('finalSolution');
            finalSolutionDiv.style.display = 'block';
            
            // 检查解的有效性
            if (!solution || !solution.variables) {
                finalSolutionDiv.innerHTML = '<div class="solution-value">无法计算最终解</div>';
                return;
            }
            
            let html = `<div class="solution-value">最优解: Z = ${solution.zValue.toFixed(2)}</div>`;
            html += '<div class="variables-values">';
            
            // 显示每个变量的值
            for (let i = 0; i < solution.variables.length; i++) {
                const value = solution.values && solution.values[i] !== undefined ? solution.values[i] : 0;
                html += `<div class="variable-value">${solution.variables[i]} = ${value.toFixed(2)}</div>`;
            }
            
            html += '</div>';
            finalSolutionDiv.innerHTML = html;
        }

        // =============================================================================
        // 单纯形法求解函数 - 核心算法
        // =============================================================================
        function simplexSolve(problemType, objectiveCoeffs, constraints) {
            const steps = [];  // 存储所有计算步骤
            
            // 转换最小化问题为最大化问题
            let c = [...objectiveCoeffs];
            if (problemType === 'min') {
                c = c.map(x => -x);  // 最小化问题转换为最大化问题
            }
            
            const m = constraints.length;  // 约束数量
            const n = c.length;           // 变量数量
            
            // 构建初始单纯形表
            let tableau = createInitialTableau(c, constraints);
            if (!tableau) {
                throw new Error("无法创建初始单纯形表");
            }
            
            // 深拷贝初始表用于显示
            const initialTableauCopy = JSON.parse(JSON.stringify(tableau));
            // 计算初始比值
            calculateRatios(initialTableauCopy);
            
            // 添加初始表到步骤
            steps.push({
                tableau: initialTableauCopy,
                description: "初始单纯形表",
                pivotRow: -1,
                pivotCol: -1
            });
            
            let iteration = 0;
            const maxIterations = 100;  // 最大迭代次数，防止无限循环
            
            // 主迭代循环
            while (iteration < maxIterations) {
                // 寻找进基变量（最大正检验数）
                let enteringVar = -1;
                let maxReducedCost = -1e-10;  // 很小的负数，用于比较
                
                for (let j = 0; j < n + m; j++) {
                    if (tableau.reducedCosts[j] > maxReducedCost) {
                        maxReducedCost = tableau.reducedCosts[j];
                        enteringVar = j;
                    }
                }
                
                // 如果所有检验数都非正，达到最优解
                if (enteringVar === -1 || maxReducedCost < 1e-10) {
                    break;
                }
                
                // 计算比值，寻找离基变量
                let leavingVar = -1;
                let minRatio = Infinity;
                
                for (let i = 0; i < m; i++) {
                    if (tableau.coefficients[i][enteringVar] > 1e-10) {
                        const ratio = tableau.solution[i] / tableau.coefficients[i][enteringVar];
                        if (ratio < minRatio) {
                            minRatio = ratio;
                            leavingVar = i;
                        }
                    }
                }
                
                // 如果无离基变量，问题无界
                if (leavingVar === -1) {
                    throw new Error("问题无界");
                }
                
                // 记录当前步骤（枢轴运算前）
                const tableauBeforePivot = JSON.parse(JSON.stringify(tableau));
                calculateRatios(tableauBeforePivot, enteringVar);
                
                steps.push({
                    tableau: tableauBeforePivot,
                    description: `第 ${iteration + 1} 次迭代`,
                    enteringVar: tableau.variables[enteringVar],
                    leavingVar: tableau.basicVars[leavingVar],
                    pivotRow: leavingVar,
                    pivotCol: enteringVar,
                    pivotValue: tableau.coefficients[leavingVar][enteringVar]
                });
                
                // 进行枢轴运算
                pivotOperation(tableau, leavingVar, enteringVar);
                
                iteration++;
            }
            
            // 添加最终步骤
            const finalTableau = JSON.parse(JSON.stringify(tableau));
            calculateRatios(finalTableau);
            const finalSolution = extractSolution(tableau, n, m, problemType);
            
            steps.push({
                tableau: finalTableau,
                description: "最终表：达到最优解",
                solution: finalSolution
            });
            
            return steps;
        }
        
        // =============================================================================
        // 创建初始单纯形表函数
        // =============================================================================
        function createInitialTableau(c, constraints) {
            const m = constraints.length;  // 约束数量
            const n = c.length;           // 变量数量
            
            // 构建变量名：x1, x2, ..., s1, s2, ...
            const variables = [];
            for (let i = 0; i < n; i++) {
                variables.push(`x${i+1}`);
            }
            for (let i = 0; i < m; i++) {
                variables.push(`s${i+1}`);  // 松弛变量
            }
            
            // 构建基变量：初始基变量都是松弛变量
            const basicVars = [];
            for (let i = 0; i < m; i++) {
                basicVars.push(`s${i+1}`);
            }
            
            // 构建CB向量：初始基变量的目标函数系数都为0
            const cb = new Array(m).fill(0);
            
            // 构建系数矩阵
            const coefficients = [];
            for (let i = 0; i < m; i++) {
                const row = [];
                // 原始变量系数
                for (let j = 0; j < n; j++) {
                    row.push(constraints[i].coefficients[j]);
                }
                // 松弛变量系数（单位矩阵）
                for (let j = 0; j < m; j++) {
                    row.push(i === j ? 1 : 0);
                }
                coefficients.push(row);
            }
            
            // 构建解向量
            const solution = constraints.map(con => con.rhs);
            
            // 计算检验数：c_j - Σ(c_b_i * a_ij)
            const reducedCosts = [...c, ...new Array(m).fill(0)];
            for (let j = 0; j < n + m; j++) {
                for (let i = 0; i < m; i++) {
                    reducedCosts[j] -= cb[i] * coefficients[i][j];
                }
            }
            
            // 计算目标函数值：Σ(c_b_i * b_i)
            let zValue = 0;
            for (let i = 0; i < m; i++) {
                zValue += cb[i] * solution[i];
            }
            
            return {
                basicVars,
                cb,
                variables,
                coefficients,
                solution,
                reducedCosts,
                zValue,
                ratios: new Array(m)  // 比值列，初始为空
            };
        }
        
        // =============================================================================
        // 计算比值函数
        // =============================================================================
        function calculateRatios(tableau, enteringVar = -1) {
            // 初始化比值数组
            if (!tableau.ratios) {
                tableau.ratios = new Array(tableau.basicVars.length);
            }
            
            // 计算每个基变量的比值
            for (let i = 0; i < tableau.basicVars.length; i++) {
                if (enteringVar >= 0 && tableau.coefficients[i][enteringVar] > 1e-10) {
                    // 比值 = 解值 / 进基变量系数
                    tableau.ratios[i] = tableau.solution[i] / tableau.coefficients[i][enteringVar];
                } else {
                    tableau.ratios[i] = null;  // 无法计算比值
                }
            }
        }
        
        // =============================================================================
        // 枢轴运算函数 - 单纯形法的核心操作
        // =============================================================================
        function pivotOperation(tableau, pivotRow, pivotCol) {
            const m = tableau.basicVars.length;
            const pivotElement = tableau.coefficients[pivotRow][pivotCol];
            
            // 检查枢轴元素是否太小
            if (Math.abs(pivotElement) < 1e-10) {
                throw new Error("枢轴元素太小，可能导致数值不稳定");
            }
            
            // 1. 更新离基行：将枢轴元素变为1
            for (let j = 0; j < tableau.coefficients[pivotRow].length; j++) {
                tableau.coefficients[pivotRow][j] /= pivotElement;
            }
            tableau.solution[pivotRow] /= pivotElement;
            
            // 2. 更新其他行：消去枢轴列的其他元素
            for (let i = 0; i < m; i++) {
                if (i !== pivotRow) {
                    const factor = tableau.coefficients[i][pivotCol];
                    for (let j = 0; j < tableau.coefficients[i].length; j++) {
                        tableau.coefficients[i][j] -= factor * tableau.coefficients[pivotRow][j];
                    }
                    tableau.solution[i] -= factor * tableau.solution[pivotRow];
                }
            }
            
            // 3. 更新检验数
            const factor = tableau.reducedCosts[pivotCol];
            for (let j = 0; j < tableau.reducedCosts.length; j++) {
                tableau.reducedCosts[j] -= factor * tableau.coefficients[pivotRow][j];
            }
            tableau.zValue -= factor * tableau.solution[pivotRow];
            
            // 4. 更新基变量
            tableau.basicVars[pivotRow] = tableau.variables[pivotCol];
            
            // 注意：在实际完整实现中，这里还应该更新CB值
            // 但在这个简化版本中，我们省略了CB值的精确更新
        }
        
        // =============================================================================
        // 提取解函数
        // =============================================================================
        function extractSolution(tableau, n, m, problemType) {
            const values = new Array(n + m).fill(0);  // 初始化所有变量值为0
            
            // 基变量的值等于解向量中的对应值
            for (let i = 0; i < m; i++) {
                const varName = tableau.basicVars[i];
                const varIndex = tableau.variables.indexOf(varName);
                if (varIndex !== -1) {
                    values[varIndex] = tableau.solution[i];
                }
            }
            
            // 调整最小化问题的目标函数值
            let zValue = tableau.zValue;
            if (problemType === 'min') {
                zValue = -zValue;  // 最小化问题需要取负
            }
            
            return {
                zValue,
                variables: [...tableau.variables],  // 所有变量名
                values                              // 所有变量值
            };
        }
    </script>
</body>
</html>